<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous">
      <link rel="stylesheet" href="../CSS/home.css">
      <link rel="stylesheet" href="../CSS/profile.css">
</head>

<body>

    <div class="navbar-container">
        <div class="vertical-navbar">
            <a href="../index.html" title="Home">
              <img src="../IMAGES/homeicon.png" class="vert-nav-images" alt="Home">
              Home
          </a>
            <a href="./form.html" title="Submit">
          <img src="../IMAGES/submiticon.png"  class="vert-nav-images" alt="Submit">
              Submit
          </a>
            <a href="./view.html" title="View">
          <img src="../IMAGES/viewicon.png" class="vert-nav-images" alt="View">
              View
          </a>
            <a href="./edit.html" title="Edit">
              <img src="../IMAGES/editicon.png" class="vert-nav-images" alt="">
              Edit</a>
          <a href="./profile.html"  style="color: blue;" title="Prof">
              <img src="../IMAGES/defaultpfpicon.png"  class="vert-nav-images" alt="Profile">
              Profile</a>
        </div>
  
        <div class="horizontal-navbar">
            <div id="greet"></div>
            <button class="btn btn-outline-success" type="button" id="signoutbutton">Sign Out</button>
        </div>
    </div>

    <div class="content">
        <div class="user-details">
            <div class="profile-picture">
                <img id="profileImageDisplay" alt="Profile Image" class="profile-img">
            </div>
            <div class="user-info">
                <p id="usernameDisplay" class="username"></p>
                <p id="bioDisplay" class="bio">Bio: [User Bio]</p>
                <p id="birthdayDisplay" class="birthday">Birthday: [User Birthday]</p>
                <p id="workplaceDisplay" class="workplace">Workplace: [User Workplace]</p>
                <p id="infoDisplay" class="additional-info">Additional Info: [User Additional Info]</p>
            </div>
        </div>
        
        <button id="toggleEdit">Edit Profile</button>
        
        <form id="profileForm" style="display:none;">
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Your username">
    
            <label for="birthday">Birthday:</label>
            <input type="date" id="birthday">
    
            <label for="workplace">Workplace:</label>
            <input type="text" id="workplace" placeholder="Your workplace">
    
            <label for="bio">Bio:</label>
            <textarea id="bio" placeholder="Tell us about yourself"></textarea>
            
            <label for="info">Information:</label>
            <textarea id="info" placeholder="Additional Information"></textarea>
    
            <label for="profilePic">Profile Picture:</label>
            <input type="file" id="profilePic" accept="image/*">
        
            <button type="submit">Save Profile</button>
        </form>
        
        <!-- Toggle button to show/hide the edit form -->
    </div>
    
    


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyAHcabQDigUfzFQ63dy_kjiaqAPZB4edtI",
            authDomain: "codinganddevelopment-e7d2c.firebaseapp.com",
            databaseURL: "https://codinganddevelopment-e7d2c-default-rtdb.firebaseio.com",
            projectId: "codinganddevelopment-e7d2c",
            storageBucket: "codinganddevelopment-e7d2c.appspot.com",
            messagingSenderId: "991250122571",
            appId: "1:991250122571:web:25d3ea280f9b9c34db8ace"
        };
    
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);
    
        document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const user = auth.currentUser;
    if (!user) {
        alert("You must be logged in to update your profile.");
        return;
    }

    // Get the current profile data
    const userProfileRef = ref(database, 'users/' + user.uid);
    get(userProfileRef).then((snapshot) => {
        if (snapshot.exists()) {
            const currentData = snapshot.val();
            
            // Only update the fields that have changed
            const updatedData = {
                username: document.getElementById('username').value || currentData.username,
                birthday: document.getElementById('birthday').value || currentData.birthday,
                workplace: document.getElementById('workplace').value || currentData.workplace,
                bio: document.getElementById('bio').value || currentData.bio,
                info: document.getElementById('info').value || currentData.info,
            };

            // Update profile data in Firebase
            set(ref(database, 'users/' + user.uid), updatedData).then(() => {
                // Handle profile picture upload if a new picture is chosen
                const profilePic = document.getElementById('profilePic').files[0];
                if (profilePic) {
                    const imageRef = storageRef(storage, 'profilePictures/' + user.uid);
                    uploadBytes(imageRef, profilePic).then((snapshot) => {
                        return getDownloadURL(snapshot.ref);
                    }).then((url) => {
                        set(ref(database, 'users/' + user.uid + '/profilePicture'), url).then(() => {
                            updateProfileDisplay(url, updatedData);
                        });
                    });
                } else {
                    updateProfileDisplay(currentData.profilePicture || null, updatedData);
                }
            }).catch((error) => {
                console.error("Error updating profile: ", error);
            });

        } else {
            console.log("No user data available");
        }
    }).catch((error) => {
        console.error("Error fetching user data: ", error);
    });
});
    
        function updateProfileDisplay(profilePicUrl, userData) {
    const profileImageDisplay = document.getElementById('profileImageDisplay');
    const finalImageUrl = profilePicUrl ? profilePicUrl : '../IMAGES/defaultpfpicon.png';

    if (profileImageDisplay) {
        profileImageDisplay.src = finalImageUrl;
    }

    if (userData) {
        document.getElementById('usernameDisplay').textContent = userData.username;
        document.getElementById('birthdayDisplay').textContent = userData.birthday ? 'Birthday: ' + userData.birthday : '';
        document.getElementById('workplaceDisplay').textContent = userData.workplace ? 'Workplace: ' + userData.workplace : '';
        document.getElementById('bioDisplay').textContent = userData.bio ? 'Bio: ' + userData.bio : '';
        document.getElementById('infoDisplay').textContent = userData.info ? 'Additional Info: ' + userData.info : '';
    }
}

    
        document.getElementById('toggleEdit').addEventListener('click', function() {
            var form = document.getElementById('profileForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        });
    
        function fetchAndDisplayProfile() {
    const user = auth.currentUser;
    if (user) {
        const userProfileRef = ref(database, 'users/' + user.uid);
        get(userProfileRef).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                updateProfileDisplay(data.profilePicture, data);
            } else {
                // Set default placeholder data
                updateProfileDisplay(null, {
                    username: 'Username',
                    bio: 'Your bio goes here...',
                    birthday: 'DD/MM/YYYY',
                    workplace: 'Your workplace',
                    info: 'Additional info...'
                });
                console.log("No user data available");
            }
        }).catch((error) => {
            console.error("Error fetching user data: ", error);
        });
    }
}

    
        window.addEventListener('load', () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    fetchAndDisplayProfile();
                } else {
                    console.log("User is not logged in");
                }
            });
        });
    </script>
    
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <script>
        let UserCreds = JSON.parse(sessionStorage.getItem("user-creds"));
        let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));

        let GreetHead = document.getElementById('greet');
        let SignoutBtn = document.getElementById('signoutbutton');


        let Signout = () => {
            sessionStorage.removeItem("user-creds");
            sessionStorage.removeItem("user-info");
            window.location.href = 'login.html'
        }

        let CheckCred = () => {
            if (!sessionStorage.getItem("user-creds")) {
                window.location.href = 'login.html';
            } else {
                GreetHead.innerText = `Welcome ${UserInfo.firstname} ${UserInfo.lastname}!`;
            }
        }

        window.addEventListener('load', CheckCred);
        SignoutBtn.addEventListener('click', Signout);
    </script>
</body>

</html>
